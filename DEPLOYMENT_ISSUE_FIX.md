# 部署問題修復說明

## 🔍 問題診斷

### 問題描述
只在下午7點和8點收到通知，其他時間都沒有收到。

### 問題原因

**根本原因**: GitHub Actions 的執行時間與發送條件不匹配

1. **GitHub Actions 執行時間**:
   - Cron: `*/10 * * * *` (每10分鐘執行一次，UTC時間)
   - 執行時間點: UTC :00, :10, :20, :30, :40, :50

2. **時間轉換**:
   - UTC :00 → 台灣時間 :08
   - UTC :10 → 台灣時間 :18
   - UTC :20 → 台灣時間 :28
   - UTC :30 → 台灣時間 :38
   - UTC :40 → 台灣時間 :48
   - UTC :50 → 台灣時間 :58

3. **原來的發送條件**:
   - 台灣時間整點（0-5分鐘）才發送
   - 只有 UTC :00 對應台灣 :08 時才會發送（0-5分鐘範圍內）
   - 其他時間點（:18, :28, :38, :48, :58）都不在 0-5 分鐘範圍內

4. **結果**:
   - 只有 UTC 11:00 (台灣 19:00) 和 UTC 12:00 (台灣 20:00) 等整點時間會發送
   - 其他時間點都不會發送

## ✅ 解決方案

### 修改內容

1. **擴大時間範圍**:
   - 將發送時間範圍從 0-5 分鐘擴大到 0-10 分鐘
   - 這樣可以涵蓋 UTC :00 對應台灣 :08 的情況

2. **添加時間間隔檢查**:
   - 記錄上次發送日報表的時間
   - 如果距離上次發送超過55分鐘，且當前時間在整點時段（0-10分鐘），就發送
   - 這樣可以確保每小時只發送一次，避免重複發送

### 修改的檔案

1. **`main.py`**:
   - 修改日報表發送時間檢查邏輯
   - 添加基於時間間隔的檢查機制
   - 確保每小時發送一次

2. **`.github/workflows/gold-price-check.yml`**:
   - 保持每10分鐘執行一次（用於價格變化警報）
   - 添加註釋說明時間轉換關係

## 📊 修復後的行為

### 日報表發送
- **發送時間**: 台灣時間整點時段（0-10分鐘）
- **發送頻率**: 每小時最多1次（距離上次發送超過55分鐘）
- **涵蓋時間點**: 
  - UTC :00 → 台灣 :08 ✓
  - UTC :10 → 台灣 :18 ✓ (如果距離上次發送超過55分鐘)
  - 其他時間點同理

### 價格變化警報
- **觸發條件**: 價格變化超過5%（相對於上次記錄的價格）
- **發送時機**: 立即發送（不限時間）
- **執行頻率**: 每10分鐘檢查一次

## 🧪 測試建議

1. **手動觸發測試**:
   ```bash
   # 在 GitHub Actions 頁面手動觸發 workflow
   # 確認可以正常發送通知
   ```

2. **觀察執行記錄**:
   - 檢查 GitHub Actions 執行日誌
   - 確認時間判斷邏輯正確
   - 確認發送時間記錄正確

3. **驗證發送頻率**:
   - 觀察是否每小時都能收到通知
   - 確認不會重複發送

## 📝 注意事項

1. **首次執行**: 
   - 如果沒有上次發送記錄，會在整點時段立即發送
   - 之後會根據時間間隔檢查

2. **時間記錄**:
   - 發送時間會記錄在 `last_report_time.json`
   - 確保這個檔案可以正常讀寫

3. **價格變化警報**:
   - 不受時間間隔限制
   - 只要價格變化超過5%就會立即發送

## 🔄 後續優化建議

如果仍然有問題，可以考慮：

1. **調整時間間隔**:
   - 將55分鐘改為50分鐘，增加發送機會
   - 或改為每小時固定時間發送

2. **修改 cron 時間**:
   - 改為每小時在 UTC :08 執行（對應台灣時間 :00）
   - 但這樣會影響價格變化警報的及時性

3. **分離日報表和警報**:
   - 創建兩個獨立的 workflow
   - 一個用於日報表（每小時執行）
   - 一個用於價格變化警報（每10分鐘執行）

## 📅 修復時間

- 問題發現: 2026-01-03
- 修復完成: 2026-01-03
- 修復版本: v1.1

