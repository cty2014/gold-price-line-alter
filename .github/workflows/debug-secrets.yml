name: Debug Secrets

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

jobs:
  debug-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: æª¢æŸ¥ Secrets æ˜¯å¦å­˜åœ¨
        run: |
          echo "=== Secrets è¨ºæ–·å ±å‘Š ==="
          echo ""
          
          # æª¢æŸ¥ CHANNEL_ACCESS_TOKEN
          if [ -z "$CHANNEL_ACCESS_TOKEN" ]; then
            echo "âŒ CHANNEL_ACCESS_TOKEN: ä¸å­˜åœ¨æˆ–ç‚ºç©º"
            echo "   è«‹æª¢æŸ¥: https://github.com/${{ github.repository }}/settings/secrets/actions"
          else
            TOKEN_LEN=${#CHANNEL_ACCESS_TOKEN}
            echo "âœ… CHANNEL_ACCESS_TOKEN: å­˜åœ¨"
            echo "   é•·åº¦: $TOKEN_LEN å­—å…ƒ"
            echo "   é–‹é ­: ${CHANNEL_ACCESS_TOKEN:0:15}..."
            echo "   çµå°¾: ...${CHANNEL_ACCESS_TOKEN: -10}"
            
            # æª¢æŸ¥æ˜¯å¦æœ‰ç©ºæ ¼
            if [[ "$CHANNEL_ACCESS_TOKEN" =~ [[:space:]] ]]; then
              echo "   âš ï¸  è­¦å‘Š: Token åŒ…å«ç©ºæ ¼å­—å…ƒï¼"
            fi
          fi
          
          echo ""
          
          # æª¢æŸ¥ USER_ID
          if [ -z "$USER_ID" ]; then
            echo "âŒ USER_ID: ä¸å­˜åœ¨æˆ–ç‚ºç©º"
          else
            USER_ID_LEN=${#USER_ID}
            echo "âœ… USER_ID: å­˜åœ¨"
            echo "   é•·åº¦: $USER_ID_LEN å­—å…ƒ"
            echo "   å€¼: $USER_ID"
            
            # æª¢æŸ¥æ ¼å¼
            if [[ "$USER_ID" =~ ^U[a-f0-9]{32}$ ]]; then
              echo "   âœ… æ ¼å¼æ­£ç¢º (U + 32ä½16é€²ä½)"
            else
              echo "   âš ï¸  æ ¼å¼å¯èƒ½ä¸æ­£ç¢º"
            fi
          fi
          
          echo ""
          echo "=== ç’°å¢ƒè³‡è¨Š ==="
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          
        env:
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
          USER_ID: ${{ secrets.USER_ID }}
      
      - name: æ¸¬è©¦ LINE API é€£ç·š
        run: |
          echo "=== æ¸¬è©¦ LINE Bot API ==="
          
          if [ -z "$CHANNEL_ACCESS_TOKEN" ]; then
            echo "âŒ ç„¡æ³•æ¸¬è©¦ï¼šToken ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ¸¬è©¦ Bot Info API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            https://api.line.me/v2/bot/info \
            -H "Authorization: Bearer $CHANNEL_ACCESS_TOKEN")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Token æœ‰æ•ˆï¼"
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "âŒ Token ç„¡æ•ˆæˆ–å·²éæœŸ"
          else
            echo "âš ï¸  æœªé æœŸçš„ç‹€æ…‹ç¢¼"
          fi
          
        env:
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
      
      - name: æ¸¬è©¦ç™¼é€è¨Šæ¯
        run: |
          echo "=== æ¸¬è©¦ç™¼é€è¨Šæ¯åˆ° USER_ID ==="
          
          if [ -z "$CHANNEL_ACCESS_TOKEN" ] || [ -z "$USER_ID" ]; then
            echo "âŒ ç„¡æ³•æ¸¬è©¦ï¼šToken æˆ– User ID ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç™¼é€æ¸¬è©¦è¨Šæ¯
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CHANNEL_ACCESS_TOKEN" \
            -d "{
              \"to\": \"$USER_ID\",
              \"messages\": [{
                \"type\": \"text\",
                \"text\": \"âœ… GitHub Actions Secrets æ¸¬è©¦æˆåŠŸï¼\\næ™‚é–“: $(date)\"
              }]
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼è«‹æª¢æŸ¥ LINE"
          elif [ "$HTTP_CODE" = "400" ]; then
            echo "âŒ è«‹æ±‚æ ¼å¼éŒ¯èª¤"
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "âŒ Token ç„¡æ•ˆ"
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "âŒ User ID ç„¡æ•ˆæˆ– Bot æ²’æœ‰æ¬Šé™"
          else
            echo "âš ï¸  æœªé æœŸçš„ç‹€æ…‹ç¢¼"
          fi
          
        env:
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
          USER_ID: ${{ secrets.USER_ID }}
      
      - name: å»ºè­°ä¿®å¾©æ­¥é©Ÿ
        if: failure()
        run: |
          echo ""
          echo "=== ğŸ”§ ä¿®å¾©å»ºè­° ==="
          echo ""
          echo "1. ç¢ºèª Secret åç¨±å®Œå…¨ä¸€è‡´ï¼ˆå€åˆ†å¤§å°å¯«ï¼‰ï¼š"
          echo "   - CHANNEL_ACCESS_TOKEN"
          echo "   - USER_ID"
          echo ""
          echo "2. æ›´æ–° Secrets çš„æ­£ç¢ºæ–¹å¼ï¼š"
          echo "   æ–¹æ³•A: ç¶²é ä»‹é¢"
          echo "   â†’ https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo ""
          echo "   æ–¹æ³•B: GitHub CLI"
          echo "   â†’ gh secret set CHANNEL_ACCESS_TOKEN"
          echo "   â†’ gh secret set USER_ID"
          echo ""
          echo "3. ç¢ºä¿ Token æ²’æœ‰å¤šé¤˜ç©ºæ ¼ï¼š"
          echo "   â†’ ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨å…ˆæª¢æŸ¥"
          echo "   â†’ æˆ–ç”¨: echo -n 'your_token' | gh secret set CHANNEL_ACCESS_TOKEN"
          echo ""

